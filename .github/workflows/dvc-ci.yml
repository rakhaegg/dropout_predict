name: DVC CI

on:
  push:
    branches:
      - master

jobs:
  dvc-check:
    runs-on: ubuntu-latest

    env:
      GDRIVE_SERVICE_ACCOUNT_JSON: ${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON }}

    steps:
      # 2. Checkout repository
      - name: Checkout Repository
        uses: actions/checkout@v3

      # 3. Setup Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      # 4. Install DVC & dependencies lainnya
      - name: Install DVC and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install \
            dvc[gdrive] \
            jupyter \
            nbconvert \
            pandas \
            numpy \
            matplotlib \
            scikit-learn \
            pillow \
            opencv-python \
            albumentations \
            pytest

      # 5. Rekonstruksi file Service Account JSON dari secret
      - name: Recreate Service Account JSON
        run: |
          mkdir -p credentials
          cat <<EOF > credentials/service-account.json
          ${{ env.GDRIVE_SERVICE_ACCOUNT_JSON }}
          EOF
          echo "=== First 5 lines of credentials/service-account.json ==="
          head -n 5 credentials/service-account.json

      # 6. Konfigurasikan DVC remote untuk Google Drive
      - name: Configure DVC Remote for Google Drive
        run: |
          # Ganti FOLDER_ID dan SA_EMAIL sesuai project Google Drive Anda
          FOLDER_ID=1slQ2wu0Lz_DPKCeKE0kZ-mge1qhUAM3e
          SA_EMAIL=dvc-gdrive-sa@seismic-octane-441403-b9.iam.gserviceaccount.com

          # Jika repo belum pernah di-dvc init, uncomment berikut:
          # dvc init

          # Hapus remote lama jika ada, agar tidak duplikat
          dvc remote remove gdrive_remote || true
          # Tambahkan remote baru sebagai default (-d)
          dvc remote add -d gdrive_remote "gdrive://${FOLDER_ID}"

          # Aktifkan penggunaan Service Account JSON secara lokal
          dvc remote modify gdrive_remote gdrive_use_service_account true
          dvc remote modify gdrive_remote --local \
            gdrive_service_account_json_file_path credentials/service-account.json
          dvc remote modify gdrive_remote --local \
            gdrive_service_account_user_email "${SA_EMAIL}"

      # 7. Tarik data dari DVC remote
      - name: DVC Pull
        run: |
          dvc pull -q

      # 8. Jalankan stratified split via DVC
      - name: Run stratified split via DVC
        run: |
          dvc repro split_dataset

      # 9. Push hasil split kembali ke remote
      - name: Push processed split to remote
        run: |
          dvc push -q split_dataset

      # 10. Jalankan unit test untuk dataset split
      - name: Run dataset unit tests
        run: |
          pytest tests/test_dataset.py

      # 11. Generate augmentation samples & jalankan test augmentasi
      - name: Generate aug samples & run augment tests
        run: |
          dvc repro augment_preview
          pytest tests/test_augment.py

      # 12. Build EDA report
      - name: Build EDA report
        run: |
          dvc repro eda_report

      # 13. Upload EDA HTML sebagai artefak
      - name: Upload EDA HTML
        uses: actions/upload-artifact@v3
        with:
          name: eda-report
          path: docs/eda_dataset.html
